<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anime/Superhero GPT</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+JP:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-bg: #ffffff;
        --secondary-bg: #f8f9fa;
        --chat-bg: #fafbfc;
        --border-color: #e1e8ed;
        --text-primary: #1a1a1a;
        --text-secondary: #6b7280;
        --accent-sakura: #ffb7c5;
        --accent-lavender: #c8b6e2;
        --accent-mint: #b8e6d3;
        --accent-peach: #ffd4c4;
        --user-bubble: #667eea;
        --ai-bubble: #ffffff;
        --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.12);
        --border-radius: 12px;
        --panel-border: 2px solid var(--border-color);
      }

      [data-theme="dark"] {
        --primary-bg: #1a1a1a;
        --secondary-bg: #2d2d2d;
        --chat-bg: #242424;
        --border-color: #404040;
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --accent-sakura: #ff8fa3;
        --accent-lavender: #a084ca;
        --accent-mint: #81c9b3;
        --accent-peach: #ffb299;
        --user-bubble: #5a67d8;
        --ai-bubble: #2d2d2d;
        --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.3);
        --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.4);
        --panel-border: 2px solid var(--border-color);
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--primary-bg);
        color: var(--text-primary);
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
      }

      .header {
        background: var(--secondary-bg);
        border-bottom: var(--panel-border);
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-light);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-family: "Noto Sans JP", sans-serif;
        font-size: 1.5rem;
        font-weight: 600;
        background: linear-gradient(
          135deg,
          var(--accent-sakura),
          var(--accent-lavender)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.02em;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .character-select {
        background: var(--primary-bg);
        border: 2px solid var(--border-color);
        border-radius: 50px;
        padding: 0.5rem 1rem;
        color: var(--text-primary);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 140px;
      }

      .character-select:hover {
        border-color: var(--accent-lavender);
      }

      .theme-toggle {
        background: none;
        border: 2px solid var(--border-color);
        border-radius: 50px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .theme-toggle:hover {
        border-color: var(--accent-lavender);
        color: var(--text-primary);
      }

      .main-container {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      .sidebar {
        width: 300px;
        background: var(--secondary-bg);
        border-right: var(--panel-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sidebar-header {
        padding: 1rem;
        border-bottom: var(--panel-border);
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .clear-history {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .clear-history:hover {
        color: var(--accent-sakura);
        background: var(--chat-bg);
      }

      .new-chat-btn {
        margin: 1rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(
          135deg,
          var(--accent-sakura),
          var(--accent-lavender)
        );
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .new-chat-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
      }

      .chat-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
      }

      .chat-item {
        padding: 0.75rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 0.5rem;
        border: 1px solid transparent;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .chat-item:hover {
        background: var(--chat-bg);
        border-color: var(--border-color);
      }

      .chat-item.active {
        background: var(--chat-bg);
        border-color: var(--accent-lavender);
      }

      .chat-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-item-title {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.875rem;
      }

      .chat-item-delete {
        color: var(--text-secondary);
        opacity: 0;
        transition: all 0.2s ease;
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat-item:hover .chat-item-delete {
        opacity: 1;
      }

      .chat-item-delete:hover {
        color: var(--accent-sakura);
        background: var(--primary-bg);
      }

      .chat-item-preview {
        font-size: 0.8rem;
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        line-height: 1.2;
      }

      .chat-item-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
        opacity: 0.7;
      }

      .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: var(--chat-bg);
        scroll-behavior: smooth;
        display: flex;
        flex-direction: column;
      }

      .chat-messages > * {
        margin-bottom: 1rem;
      }

      .message {
        margin-bottom: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        animation: slideIn 0.3s ease-out;
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-bubble {
        max-width: 70%;
        padding: 1rem 1.25rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-light);
        position: relative;
        border: var(--panel-border);
        line-height: 1.5;
      }

      .message.user .message-bubble {
        background: var(--user-bubble);
        color: white;
        border-top-right-radius: 4px;
      }

      .message.ai .message-bubble {
        background: var(--ai-bubble);
        color: var(--text-primary);
        border-top-left-radius: 4px;
        border-left: 4px solid var(--accent-sakura);
      }

      .message-content {
        font-size: 0.95rem;
      }

      .message-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin: 4px 8px;
        opacity: 0.7;
      }

      .loading-dots {
        display: inline-flex;
        gap: 0.3rem;
        margin: 0.5rem 0;
        animation: loadingPulse 1.4s infinite;
      }

      .loading-dots .dot {
        width: 6px;
        height: 6px;
        background: var(--accent-sakura);
        border-radius: 50%;
        animation: dotPulse 1.4s infinite;
      }

      .loading-dots .dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .loading-dots .dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      .message.loading {
        opacity: 0.7;
      }

      .message.loading .message-bubble {
        background: var(--secondary-bg);
        border-color: var(--border-color);
      }

      @keyframes loadingPulse {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
      }

      @keyframes dotPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
        }
      }

      .input-area {
        background: var(--secondary-bg);
        border-top: var(--panel-border);
        padding: 1.5rem;
        box-shadow: var(--shadow-medium);
      }

      .input-container {
        display: flex;
        gap: 1rem;
        max-width: 1200px;
        margin: 0 auto;
      }

      .message-input {
        flex: 1;
        padding: 1rem 1.25rem;
        border: 2px solid var(--border-color);
        border-radius: 50px;
        background: var(--primary-bg);
        color: var(--text-primary);
        font-size: 0.95rem;
        font-family: inherit;
        outline: none;
        transition: all 0.2s ease;
        resize: none;
        min-height: 48px;
        max-height: 120px;
      }

      .message-input:focus {
        border-color: var(--accent-lavender);
        box-shadow: 0 0 0 3px rgba(200, 182, 226, 0.1);
      }

      .send-button {
        background: linear-gradient(
          135deg,
          var(--accent-sakura),
          var(--accent-lavender)
        );
        border: none;
        border-radius: 50px;
        padding: 0.75rem 1.5rem;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        min-width: 80px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .send-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
      }

      .send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .welcome-message {
        text-align: center;
        padding: 3rem 1.5rem;
        color: var(--text-secondary);
      }

      .welcome-title {
        font-family: "Noto Sans JP", sans-serif;
        font-size: 1.5rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        background: linear-gradient(
          135deg,
          var(--accent-sakura),
          var(--accent-lavender)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .welcome-subtitle {
        font-size: 0.95rem;
        line-height: 1.5;
        margin-top: 0.5rem;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Chat Header Styles */
      .chat-header {
        padding: 1rem 1.5rem;
        background: var(--secondary-bg);
        border-bottom: var(--panel-border);
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .character-avatar-placeholder {
        width: 48px;
        height: 48px;
        background: linear-gradient(
          135deg,
          var(--accent-sakura),
          var(--accent-lavender)
        );
        border-radius: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.2rem;
        flex-shrink: 0;
      }

      .character-info {
        flex: 1;
        min-width: 0;
      }

      .character-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        font-size: 1rem;
      }

      .character-details {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 0.25rem;
      }

      .character-tag {
        background: var(--accent-lavender);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .character-personality {
        font-size: 0.875rem;
        color: var(--text-secondary);
        line-height: 1.4;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          max-height: 200px;
        }

        .header {
          padding: 1rem;
          flex-direction: column;
          gap: 1rem;
        }

        .header-controls {
          width: 100%;
          justify-content: center;
        }

        .message-bubble {
          max-width: 85%;
        }

        .input-area {
          padding: 1rem;
        }

        .input-container {
          gap: 0.75rem;
        }

        .character-details {
          gap: 0.25rem;
        }

        .character-tag {
          font-size: 0.7rem;
        }
      }

      .chat-messages::-webkit-scrollbar {
        width: 6px;
      }

      .chat-messages::-webkit-scrollbar-track {
        background: var(--secondary-bg);
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: var(--accent-lavender);
        border-radius: 3px;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: var(--accent-sakura);
      }

      .chat-list::-webkit-scrollbar {
        width: 4px;
      }

      .chat-list::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-list::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <h1 class="logo">Anime/Superhero GPT</h1>
      <div class="header-controls">
        <select id="character" class="character-select">
          {% for char in characters %}
          <option
            value="{{ char.name }}"
            data-traits="{{ char.traits }}"
            data-universe="{{ char.universe or '' }}"
            data-alias="{{ char.alias or '' }}"
            data-greeting="{{ char.greeting or '' }}"
          >
            {{ char.name }}
          </option>
          {% endfor %}
        </select>
        <button class="theme-toggle" id="themeToggle">
          <span id="themeIcon">üåô</span>
          <span id="themeText">Dark</span>
        </button>
      </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          Chat History
          <button
            class="clear-history"
            id="clearHistory"
            title="Clear All History"
          >
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <button class="new-chat-btn" id="newChat">
          <i class="fas fa-plus"></i>
          New Chat
        </button>
        <div class="chat-list" id="chatList">
          <!-- Chat history items will be added here -->
        </div>
      </div>

      <!-- Content Area -->
      <div class="content-area">
        <!-- Chat Header -->
        <div class="chat-header" id="chatHeader">
          <div class="character-avatar-placeholder" id="characterAvatar"></div>
          <div class="character-info">
            <div class="character-name" id="characterName"></div>
            <div class="character-details" id="characterDetails"></div>
            <div class="character-personality" id="characterPersonality"></div>
          </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
              <h2 class="welcome-title">Welcome to Anime/Superhero Chat!</h2>
              <p class="welcome-subtitle" id="welcomeMessage"></p>
            </div>
          </div>

          <!-- Input Area -->
          <div class="input-area">
            <div class="input-container">
              <textarea
                class="message-input"
                id="messageInput"
                placeholder="Type your message..."
                rows="1"
              ></textarea>
              <button class="send-button" id="sendButton">
                <span>Send</span>
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===== 1Ô∏è‚É£ Global App State =====
      window.chatApp = {
        currentChatId: null,
        activeCharacter: null,
        isProcessing: false,
        chatHistory: {},
        elements: {
          themeToggle: document.getElementById("themeToggle"),
          themeIcon: document.getElementById("themeIcon"),
          themeText: document.getElementById("themeText"),
          body: document.body,
          characterSelect: document.getElementById("character"),
          chatMessages: document.getElementById("chatMessages"),
          messageInput: document.getElementById("messageInput"),
          sendButton: document.getElementById("sendButton"),
          chatList: document.getElementById("chatList"),
          newChatBtn: document.getElementById("newChat"),
          clearHistoryBtn: document.getElementById("clearHistory"),
        },
      };

      const { elements } = window.chatApp;
      const {
        themeToggle,
        themeIcon,
        themeText,
        body,
        characterSelect,
        chatMessages,
        messageInput,
        sendButton,
        chatList,
        newChatBtn,
        clearHistoryBtn,
      } = elements;

      // ===== 2Ô∏è‚É£ Parse server-side chat history =====
      try {
        console.log("Initializing chat history...");
        const rawHistory = "{{ chat_history | tojson | safe }}";
        const cleanHistory = rawHistory.replace(
          /[\u0000-\u001F\u007F-\u009F]/g,
          ""
        );
        const parsedHistory = JSON.parse(cleanHistory || "{}");
        window.chatApp.chatHistory = parsedHistory;
        console.log("Parsed chat history:", window.chatApp.chatHistory);
      } catch (e) {
        console.error("Error parsing chat history:", e);
        window.chatApp.chatHistory = {};
      }

      // ===== 3Ô∏è‚É£ Theme toggle =====
      let isDark = true;
      body.setAttribute("data-theme", "dark");
      themeToggle.addEventListener("click", () => {
        isDark = !isDark;
        if (isDark) {
          body.setAttribute("data-theme", "dark");
          themeIcon.textContent = "‚òÄÔ∏è";
          themeText.textContent = "Light";
        } else {
          body.removeAttribute("data-theme");
          themeIcon.textContent = "üåô";
          themeText.textContent = "Dark";
        }
      });

      // ===== 4Ô∏è‚É£ Helper Functions =====
      function formatTime(timestamp) {
        if (timestamp < 1000000000000) timestamp *= 1000;
        const diff = Date.now() - timestamp;
        if (diff < 0 || diff > 315576000000) return "Unknown time";
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        if (minutes < 1) return "Just now";
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 30) return `${days}d ago`;
        return new Date(timestamp).toLocaleDateString();
      }

      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function parseMarkdown(text) {
        return text
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>")
          .replace(
            /^### (.*$)/gm,
            '<h3 style="margin:0.5rem 0; color: var(--accent-sakura);">$1</h3>'
          )
          .replace(
            /^## (.*$)/gm,
            '<h2 style="margin:0.5rem 0; color: var(--accent-sakura);">$1</h2>'
          )
          .replace(
            /^# (.*$)/gm,
            '<h1 style="margin:0.5rem 0; color: var(--accent-sakura);">$1</h1>'
          )
          .replace(/^- (.*$)/gm, '<li style="margin-left:1rem;">$1</li>')
          .replace(
            /^\d+\. (.*$)/gm,
            '<li style="margin-left:1rem; list-style-type:decimal;">$1</li>'
          )
          .replace(/(<li.*<\/li>)/s, '<ul style="margin:0.5rem 0;">$1</ul>')
          .replace(
            /^> (.*$)/gm,
            '<blockquote style="border-left:3px solid var(--accent-lavender); padding-left:1rem; margin:0.5rem 0; font-style:italic;">$1</blockquote>'
          )
          .replace(
            /`(.*?)`/g,
            '<code style="background: var(--secondary-bg); padding:0.2rem 0.4rem; border-radius:4px; font-family: monospace;">$1</code>'
          )
          .replace(
            /\[(.*?)\]\((.*?)\)/g,
            '<a href="$2" target="_blank" style="color: var(--accent-lavender); text-decoration: underline;">$1</a>'
          )
          .replace(/\n/g, "<br>");
      }

      // ===== 5Ô∏è‚É£ Chat Functions =====
      function addMessage(content, type, character = "", timestamp = null) {
        timestamp = timestamp || Date.now();
        if (timestamp < 1000000000000) timestamp *= 1000;

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;
        messageDiv.dataset.timestamp = timestamp;

        const timeDisplay = document.createElement("div");
        timeDisplay.className = "message-time";
        timeDisplay.textContent = formatTime(timestamp);
        messageDiv.appendChild(timeDisplay);

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";

        const messageContent = document.createElement("div");
        messageContent.className = "message-content";

        if (type === "ai") {
          messageContent.innerHTML = parseMarkdown(content);
        } else {
          messageContent.innerHTML = escapeHtml(content).replace(/\n/g, "<br>");
        }

        bubble.appendChild(messageContent);
        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addLoadingMessage() {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message ai loading";
        const bubble = document.createElement("div");
        bubble.className = "message-bubble";
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "loading-dots";
        loadingDiv.innerHTML =
          '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
        bubble.appendChild(loadingDiv);
        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageDiv;
      }

      function updateChatList() {
        chatList.innerHTML = "";
        const chats = Object.values(window.chatApp.chatHistory)
          .filter((chat) => chat && chat.messages && chat.messages.length > 0)
          .sort((a, b) => (b.lastActivity || 0) - (a.lastActivity || 0));

        chats.forEach((chat) => {
          const chatItem = document.createElement("div");
          chatItem.className = `chat-item ${
            chat.id === window.chatApp.currentChatId ? "active" : ""
          }`;
          const lastMessage =
            chat.messages[chat.messages.length - 1]?.content || "New chat";
          const preview =
            lastMessage.length > 40
              ? lastMessage.substring(0, 40) + "..."
              : lastMessage;
          const displayCharacter = chat.character || characterSelect.value;

          chatItem.innerHTML = `
              <div class="chat-item-header">
                  <div class="chat-item-title">${displayCharacter}</div>
                  <button class="chat-item-delete" title="Delete chat">
                      <i class="fas fa-trash-alt"></i>
                  </button>
              </div>
              <div class="chat-item-preview">${preview}</div>
              <div class="chat-item-time">${formatTime(
                chat.lastActivity || Date.now()
              )}</div>
          `;

          chatItem.onclick = (e) => {
            if (!e.target.closest(".chat-item-delete")) loadChat(chat.id);
          };

          chatItem.querySelector(".chat-item-delete").onclick = (e) => {
            e.stopPropagation();
            if (confirm(`Delete chat with ${chat.character}?`)) {
              delete window.chatApp.chatHistory[chat.id];
              if (window.chatApp.currentChatId === chat.id) createNewChat();
              else updateChatList();
            }
          };

          chatList.appendChild(chatItem);
        });
      }

      function createNewChat(selectedCharacter = null) {
        const chatId = "chat_" + Date.now();
        const character = selectedCharacter || characterSelect.value;

        window.chatApp.chatHistory[chatId] = {
          id: chatId,
          character: character,
          messages: [],
          lastActivity: Date.now(),
        };

        window.chatApp.currentChatId = chatId;
        window.chatApp.activeCharacter = character;

        chatMessages.innerHTML = "";
        const welcomeDiv = document.createElement("div");
        welcomeDiv.className = "welcome-message";
        welcomeDiv.innerHTML = `<h2 class="welcome-title">Chat with ${character}</h2>
          <p class="welcome-subtitle">Start chatting with ${character}!</p>`;
        chatMessages.appendChild(welcomeDiv);

        updateChatList();
        updateCharacterInfo();
      }

      function loadChat(chatId) {
        const chat = window.chatApp.chatHistory[chatId];
        if (!chat) return;

        window.chatApp.currentChatId = chatId;
        window.chatApp.activeCharacter = chat.character;

        if (characterSelect.value !== chat.character)
          characterSelect.value = chat.character;

        updateCharacterInfo();
        chatMessages.innerHTML = "";
        if (chat.messages.length === 0) createNewChat(chat.character);
        else
          chat.messages.forEach((msg) => {
            addMessage(
              msg.content,
              msg.type || msg.role,
              msg.character || chat.character,
              msg.timestamp
            );
          });

        updateChatList();
      }

      function updateCharacterInfo() {
        const selectedOption =
          characterSelect.options[characterSelect.selectedIndex];
        const character = selectedOption.text;
        const traits = selectedOption.dataset.traits;
        const universe = selectedOption.dataset.universe;
        const alias = selectedOption.dataset.alias;
        const greeting = selectedOption.dataset.greeting;

        document.getElementById("characterName").textContent = character;
        document.getElementById("characterPersonality").textContent =
          traits || "No personality traits available";
        const detailsContainer = document.getElementById("characterDetails");
        detailsContainer.innerHTML = "";
        if (universe)
          detailsContainer.innerHTML += `<div class="character-tag">${universe}</div>`;
        if (alias)
          detailsContainer.innerHTML += `<div class="character-tag">${alias}</div>`;
        const avatarPlaceholder = document.getElementById("characterAvatar");
        avatarPlaceholder.innerHTML = character.charAt(0);
        const welcomeMessage = document.getElementById(
          "welcomeCharacterMessage"
        );
        if (welcomeMessage)
          welcomeMessage.textContent =
            greeting || `Start chatting with ${character}!`;
      }

      // ===== 6Ô∏è‚É£ Initialize chat state =====
      function initializeChatState() {
        const chats = Object.values(window.chatApp.chatHistory).filter(
          (c) => c && c.messages?.length > 0
        );
        if (chats.length === 0) return createNewChat();

        const sorted = chats.sort(
          (a, b) => (b.lastActivity || 0) - (a.lastActivity || 0)
        );
        const recent = sorted[0];
        window.chatApp.currentChatId = recent.id;
        window.chatApp.activeCharacter =
          recent.character || characterSelect.value;

        loadChat(recent.id);
      }

      initializeChatState();

      // ===== 7Ô∏è‚É£ Event Listeners =====
      characterSelect.addEventListener("change", () =>
        createNewChat(characterSelect.value)
      );
      newChatBtn.addEventListener("click", () => createNewChat());
      clearHistoryBtn.addEventListener("click", () => {
        if (confirm("Clear all chat history?")) {
          window.chatApp.chatHistory = {};
          createNewChat();
        }
      });

      messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 120) + "px";
      });

      messageInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      sendButton.addEventListener("click", sendMessage);

      async function sendMessage() {
        const message = messageInput.value.trim();
        const char = characterSelect.value;
        if (!message || window.chatApp.isProcessing) return;

        window.chatApp.isProcessing = true;
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        document.querySelector(".welcome-message")?.remove();

        const userMsg = {
          content: message,
          type: "user",
          timestamp: Date.now(),
          chatId: window.chatApp.currentChatId,
        };
        addMessage(message, "user");
        window.chatApp.chatHistory[window.chatApp.currentChatId].messages.push(
          userMsg
        );
        window.chatApp.chatHistory[window.chatApp.currentChatId].lastActivity =
          Date.now();

        messageInput.value = "";
        messageInput.style.height = "auto";

        const loading = addLoadingMessage();

        try {
          const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message,
              character: char,
              chatId: window.chatApp.currentChatId,
            }),
          });
          const data = await res.json();
          loading.remove();

          const aiMsg = {
            content: data.reply,
            type: "ai",
            timestamp: Date.now(),
            chatId: window.chatApp.currentChatId,
          };
          addMessage(data.reply, "ai");
          window.chatApp.chatHistory[
            window.chatApp.currentChatId
          ].messages.push(aiMsg);
          window.chatApp.chatHistory[
            window.chatApp.currentChatId
          ].lastActivity = Date.now();
        } catch (err) {
          loading.remove();
          addMessage("Error: Could not get response from server.", "ai");
          console.error(err);
        }

        updateChatList();
        window.chatApp.isProcessing = false;
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
      }
    </script>
  </body>
</html>
