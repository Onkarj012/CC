<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anime/Superhero GPT</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+JP:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-bg: #ffffff;
        --secondary-bg: #f8f9fa;
        --chat-bg: #fafbfc;
        --border-color: #e1e8ed;
        --text-primary: #1a1a1a;
        --text-secondary: #6b7280;
        --accent-sakura: #ffb7c5;
        --accent-lavender: #c8b6e2;
        --accent-mint: #b8e6d3;
        --accent-peach: #ffd4c4;
        --user-bubble: #667eea;
        --ai-bubble: #ffffff;
        --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.12);
        --border-radius: 12px;
        --panel-border: 2px solid var(--border-color);
      }

      [data-theme="dark"] {
        --primary-bg: #1a1a1a;
        --secondary-bg: #2d2d2d;
        --chat-bg: #242424;
        --border-color: #404040;
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --accent-sakura: #ff8fa3;
        --accent-lavender: #a084ca;
        --accent-mint: #81c9b3;
        --accent-peach: #ffb299;
        --user-bubble: #5a67d8;
        --ai-bubble: #2d2d2d;
        --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.3);
        --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.4);
        --panel-border: 2px solid var(--border-color);
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--primary-bg);
        color: var(--text-primary);
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
      }

      .header {
        background: var(--secondary-bg);
        border-bottom: var(--panel-border);
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-light);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-family: "Noto Sans JP", sans-serif;
        font-size: 1.5rem;
        font-weight: 600;
        background: linear-gradient(
          135deg,
          var(--accent-sakura),
          var(--accent-lavender)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.02em;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .character-select {
        background: var(--primary-bg);
        border: 2px solid var(--border-color);
        border-radius: 50px;
        padding: 0.5rem 1rem;
        color: var(--text-primary);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 140px;
      }

      .character-select:hover {
        border-color: var(--accent-lavender);
      }

      .theme-toggle {
        background: none;
        border: 2px solid var(--border-color);
        border-radius: 50px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .theme-toggle:hover {
        border-color: var(--accent-lavender);
        color: var(--text-primary);
      }

      .main-container {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      .sidebar {
        width: 300px;
        background: var(--secondary-bg);
        border-right: var(--panel-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sidebar-header {
        padding: 1rem;
        border-bottom: var(--panel-border);
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .clear-history {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .clear-history:hover {
        color: var(--accent-sakura);
        background: var(--chat-bg);
      }

      .new-chat-btn {
        margin: 1rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(
          135deg,
          var(--accent-sakura),
          var(--accent-lavender)
        );
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .new-chat-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
      }

      .chat-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
      }

      .chat-item {
        padding: 0.75rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 0.5rem;
        border: 1px solid transparent;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .chat-item:hover {
        background: var(--chat-bg);
        border-color: var(--border-color);
      }

      .chat-item.active {
        background: var(--chat-bg);
        border-color: var(--accent-lavender);
      }

      .chat-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-item-title {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.875rem;
      }

      .chat-item-delete {
        color: var(--text-secondary);
        opacity: 0;
        transition: all 0.2s ease;
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat-item:hover .chat-item-delete {
        opacity: 1;
      }

      .chat-item-delete:hover {
        color: var(--accent-sakura);
        background: var(--primary-bg);
      }

      .chat-item-preview {
        font-size: 0.8rem;
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        line-height: 1.2;
      }

      .chat-item-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
        opacity: 0.7;
      }

      .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: var(--chat-bg);
        scroll-behavior: smooth;
        display: flex;
        flex-direction: column;
      }

      .chat-messages > * {
        margin-bottom: 1rem;
      }

      .message {
        margin-bottom: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        animation: slideIn 0.3s ease-out;
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-bubble {
        max-width: 70%;
        padding: 1rem 1.25rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-light);
        position: relative;
        border: var(--panel-border);
        line-height: 1.5;
      }

      .message.user .message-bubble {
        background: var(--user-bubble);
        color: white;
        border-top-right-radius: 4px;
      }

      .message.ai .message-bubble {
        background: var(--ai-bubble);
        color: var(--text-primary);
        border-top-left-radius: 4px;
        border-left: 4px solid var(--accent-sakura);
      }

      .message-content {
        font-size: 0.95rem;
      }

      .message-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin: 4px 8px;
        opacity: 0.7;
      }

      .loading-dots {
        display: inline-flex;
        gap: 0.3rem;
        margin: 0.5rem 0;
        animation: loadingPulse 1.4s infinite;
      }

      .loading-dots .dot {
        width: 6px;
        height: 6px;
        background: var(--accent-sakura);
        border-radius: 50%;
        animation: dotPulse 1.4s infinite;
      }

      .loading-dots .dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .loading-dots .dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      .message.loading {
        opacity: 0.7;
      }

      .message.loading .message-bubble {
        background: var(--secondary-bg);
        border-color: var(--border-color);
      }

      @keyframes loadingPulse {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
      }

      @keyframes dotPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
        }
      }

      .input-area {
        background: var(--secondary-bg);
        border-top: var(--panel-border);
        padding: 1.5rem;
        box-shadow: var(--shadow-medium);
      }

      .input-container {
        display: flex;
        gap: 1rem;
        max-width: 1200px;
        margin: 0 auto;
      }

      .message-input {
        flex: 1;
        padding: 1rem 1.25rem;
        border: 2px solid var(--border-color);
        border-radius: 50px;
        background: var(--primary-bg);
        color: var(--text-primary);
        font-size: 0.95rem;
        font-family: inherit;
        outline: none;
        transition: all 0.2s ease;
        resize: none;
        min-height: 48px;
        max-height: 120px;
      }

      .message-input:focus {
        border-color: var(--accent-lavender);
        box-shadow: 0 0 0 3px rgba(200, 182, 226, 0.1);
      }

      .send-button {
        background: linear-gradient(
          135deg,
          var(--accent-sakura),
          var(--accent-lavender)
        );
        border: none;
        border-radius: 50px;
        padding: 0.75rem 1.5rem;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        min-width: 80px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .send-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
      }

      .send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .welcome-message {
        text-align: center;
        padding: 3rem 1.5rem;
        color: var(--text-secondary);
      }

      .welcome-title {
        font-family: "Noto Sans JP", sans-serif;
        font-size: 1.5rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        background: linear-gradient(
          135deg,
          var(--accent-sakura),
          var(--accent-lavender)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .welcome-subtitle {
        font-size: 0.95rem;
        line-height: 1.5;
        margin-top: 0.5rem;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Chat Header Styles */
      .chat-header {
        padding: 1rem 1.5rem;
        background: var(--secondary-bg);
        border-bottom: var(--panel-border);
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .character-avatar-placeholder {
        width: 48px;
        height: 48px;
        background: linear-gradient(
          135deg,
          var(--accent-sakura),
          var(--accent-lavender)
        );
        border-radius: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.2rem;
        flex-shrink: 0;
      }

      .character-info {
        flex: 1;
        min-width: 0;
      }

      .character-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        font-size: 1rem;
      }

      .character-details {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 0.25rem;
      }

      .character-tag {
        background: var(--accent-lavender);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .character-personality {
        font-size: 0.875rem;
        color: var(--text-secondary);
        line-height: 1.4;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          max-height: 200px;
        }

        .header {
          padding: 1rem;
          flex-direction: column;
          gap: 1rem;
        }

        .header-controls {
          width: 100%;
          justify-content: center;
        }

        .message-bubble {
          max-width: 85%;
        }

        .input-area {
          padding: 1rem;
        }

        .input-container {
          gap: 0.75rem;
        }

        .character-details {
          gap: 0.25rem;
        }

        .character-tag {
          font-size: 0.7rem;
        }
      }

      .chat-messages::-webkit-scrollbar {
        width: 6px;
      }

      .chat-messages::-webkit-scrollbar-track {
        background: var(--secondary-bg);
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: var(--accent-lavender);
        border-radius: 3px;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: var(--accent-sakura);
      }

      .chat-list::-webkit-scrollbar {
        width: 4px;
      }

      .chat-list::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-list::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <h1 class="logo">Anime/Superhero GPT</h1>
      <div class="header-controls">
        <select id="character" class="character-select">
          {% for char in characters %}
          <option
            value="{{ char.name }}"
            data-traits="{{ char.traits }}"
            data-universe="{{ char.universe or '' }}"
            data-alias="{{ char.alias or '' }}"
            data-greeting="{{ char.greeting or '' }}"
          >
            {{ char.name }}
          </option>
          {% endfor %}
        </select>
        <button class="theme-toggle" id="themeToggle">
          <span id="themeIcon">üåô</span>
          <span id="themeText">Dark</span>
        </button>
      </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          Chat History
          <button
            class="clear-history"
            id="clearHistory"
            title="Clear All History"
          >
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <button class="new-chat-btn" id="newChat">
          <i class="fas fa-plus"></i>
          New Chat
        </button>
        <div class="chat-list" id="chatList">
          <!-- Chat history items will be added here -->
        </div>
      </div>

      <!-- Content Area -->
      <div class="content-area">
        <!-- Chat Header -->
        <div class="chat-header" id="chatHeader">
          <div class="character-avatar-placeholder" id="characterAvatar"></div>
          <div class="character-info">
            <div class="character-name" id="characterName"></div>
            <div class="character-details" id="characterDetails"></div>
            <div class="character-personality" id="characterPersonality"></div>
          </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
              <h2 class="welcome-title">Welcome to Anime/Superhero Chat!</h2>
              <p class="welcome-subtitle" id="welcomeMessage"></p>
            </div>
          </div>

          <!-- Input Area -->
          <div class="input-area">
            <div class="input-container">
              <textarea
                class="message-input"
                id="messageInput"
                placeholder="Type your message..."
                rows="1"
              ></textarea>
              <button class="send-button" id="sendButton">
                <span>Send</span>
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
            // Initialize state
      let chatHistory = {};
      try {
          console.log('Initializing chat history...');
          const rawHistory = '{{ chat_history | tojson | safe }}';
          console.log('Raw history:', rawHistory);

          const initialData = JSON.parse(rawHistory || '{}');
          console.log('Parsed initial data:', initialData);

          // Initialize chatHistory
          if (Array.isArray(initialData)) {
              // Handle old format (array of messages)
              console.log('Processing array format history');
              initialData.forEach(msg => {
                  const chatId = msg.chatId || ('chat_' + Date.now());
                  const now = Date.now();
                  const msgTimestamp = msg.timestamp ? (msg.timestamp < 1000000000000 ? msg.timestamp * 1000 : msg.timestamp) : now;

                  if (!chatHistory[chatId]) {
                      // Get character from message or select
                      const character = (msg.character && msg.character !== 'Unknown')
                          ? msg.character
                          : characterSelect.value;

                      console.log(`Creating new chat ${chatId} with character ${character}`);
                      chatHistory[chatId] = {
                          id: chatId,
                          character: character,
                          messages: [],
                          lastActivity: msgTimestamp
                      };
                  }

                  // Ensure message has proper character
                  msg.character = chatHistory[chatId].character;
                  msg.timestamp = msgTimestamp;

                  chatHistory[chatId].messages.push(msg);
                  chatHistory[chatId].lastActivity = Math.max(
                      chatHistory[chatId].lastActivity,
                      msgTimestamp
                  );
              });
          } else {
              // Handle grouped format
              console.log('Processing grouped format history');
              Object.entries(initialData).forEach(([chatId, chat]) => {
                  const now = Date.now();

                  // Ensure character is set
                  if (!chat.character || chat.character === 'Unknown') {
                      chat.character = characterSelect.value;
                  }

                  // Fix timestamps in messages
                  chat.messages = chat.messages.map(msg => ({
                      ...msg,
                      timestamp: msg.timestamp ? (msg.timestamp < 1000000000000 ? msg.timestamp * 1000 : msg.timestamp) : now,
                      character: msg.character || chat.character
                  }));

                  // Update lastActivity
                  chat.lastActivity = Math.max(
                      ...chat.messages.map(m => m.timestamp),
                      chat.lastActivity || 0,
                      now
                  );

                  chatHistory[chatId] = chat;
              });
          }

          console.log('Final chat history:', chatHistory);

          // Load most recent chat
          const sortedChats = Object.values(chatHistory)
              .sort((a, b) => b.lastActivity - a.lastActivity);

          if (sortedChats.length > 0) {
              console.log('Loading most recent chat:', sortedChats[0]);
              const mostRecentChat = sortedChats[0];
              currentChatId = mostRecentChat.id;
              activeCharacter = mostRecentChat.character;

              // Update character select to match the loaded chat
              if (characterSelect.value !== activeCharacter) {
                  console.log('Updating character select to:', activeCharacter);
                  characterSelect.value = activeCharacter;
              }

              // Update character info
              updateCharacterInfo();
          }
      } catch (e) {
          console.error('Error parsing chat history:', e);
          chatHistory = {};
      }

            let currentChatId = null;
            let activeCharacter = null;
            let isProcessing = false;

            // DOM elements
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            const body = document.body;
            const characterSelect = document.getElementById('character');
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const chatList = document.getElementById('chatList');
            const newChatBtn = document.getElementById('newChat');
            const clearHistoryBtn = document.getElementById('clearHistory');

            // Initialize theme
            let isDark = true;
            body.setAttribute('data-theme', 'dark');

            themeToggle.addEventListener('click', () => {
                isDark = !isDark;
                if (isDark) {
                    body.setAttribute('data-theme', 'dark');
                    themeIcon.textContent = '‚òÄÔ∏è';
                    themeText.textContent = 'Light';
                } else {
                    body.removeAttribute('data-theme');
                    themeIcon.textContent = 'üåô';
                    themeText.textContent = 'Dark';
                }
            });

            // Initialize characters data
            const charactersData = {{ characters | tojson | safe }};

            // Create new chat
            function createNewChat(selectedCharacter = null) {
                const chatId = 'chat_' + Date.now();
                const character = selectedCharacter || characterSelect.value;

                // Create new chat object
                chatHistory[chatId] = {
                    id: chatId,
                    character: character,
                    messages: [],
                    lastActivity: Date.now()
                };

                currentChatId = chatId;
                activeCharacter = character;

                // Clear messages
                chatMessages.innerHTML = '';

                // Add welcome message
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'welcome-message';
                welcomeDiv.innerHTML = `
                    <h2 class="welcome-title">Chat with ${character}</h2>
                    <div id="characterImageContainer">
                        <p class="welcome-subtitle" style="color: var(--text-secondary);">
                            <i class="fas fa-image"></i> Loading character image...
                        </p>
                    </div>
                    <p class="welcome-subtitle" id="welcomeCharacterMessage"></p>
                `;
                chatMessages.appendChild(welcomeDiv);

                // Try to load character image from S3
                fetch('/get_character_image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ character: character })
                })
                .then(res => res.json())
                .then(data => {
                    const imageContainer = document.getElementById('characterImageContainer');
                    if (data.image_url) {
                        imageContainer.innerHTML = `
                            <img src="${data.image_url}"
                                 alt="${character}"
                                 style="max-width: 200px; border-radius: 10px; margin: 20px auto; display: block; box-shadow: var(--shadow-medium);"
                                 onerror="this.onerror=null; this.parentElement.innerHTML='<p class=\'welcome-subtitle\' style=\'color: var(--text-secondary);\'><i class=\'fas fa-image\'></i> No image available for this character</p>';">
                        `;
                    } else {
                        imageContainer.innerHTML = '<p class="welcome-subtitle" style="color: var(--text-secondary);"><i class="fas fa-image"></i> No image available for this character</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading character image:', error);
                    const imageContainer = document.getElementById('characterImageContainer');
                    imageContainer.innerHTML = '<p class="welcome-subtitle" style="color: var(--text-secondary);"><i class="fas fa-exclamation-triangle"></i> Failed to load character image</p>';
                });

                // Update chat list
                updateChatList();
                updateCharacterInfo();
            }

            // Update character info in header and welcome message
            function updateCharacterInfo() {
                const selectedOption = characterSelect.options[characterSelect.selectedIndex];
                const character = selectedOption.text;
                const traits = selectedOption.dataset.traits;
                const universe = selectedOption.dataset.universe;
                const alias = selectedOption.dataset.alias;
                const greeting = selectedOption.dataset.greeting;

                // Update header
                document.getElementById('characterName').textContent = character;

                const detailsContainer = document.getElementById('characterDetails');
                detailsContainer.innerHTML = '';

                if (universe) {
                    const universeTag = document.createElement('div');
                    universeTag.className = 'character-tag';
                    universeTag.textContent = universe;
                    detailsContainer.appendChild(universeTag);
                }

                if (alias) {
                    const aliasTag = document.createElement('div');
                    aliasTag.className = 'character-tag';
                    aliasTag.textContent = alias;
                    detailsContainer.appendChild(aliasTag);
                }

                document.getElementById('characterPersonality').textContent = traits || 'No personality traits available';

                // Update avatar placeholder with first letter
                const avatarPlaceholder = document.getElementById('characterAvatar');
                avatarPlaceholder.innerHTML = character.charAt(0);

                // Update welcome message
                const welcomeMessage = document.getElementById('welcomeCharacterMessage');
                if (welcomeMessage) {
                    welcomeMessage.textContent = greeting || `Start chatting with ${character}! Ask about anything!`;
                }

                // Try to load character image for avatar
                fetch('/get_character_image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ character: character })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.image_url) {
                        const img = document.createElement('img');
                        img.src = data.image_url;
                        img.alt = character;
                        img.style.width = '48px';
                        img.style.height = '48px';
                        img.style.borderRadius = '24px';
                        img.style.objectFit = 'cover';

                        const avatar = document.getElementById('characterAvatar');
                        avatar.innerHTML = '';
                        avatar.appendChild(img);
                    }
                })
                .catch(error => {
                    console.error('Error loading character image:', error);
                });
            }

            // Format timestamp for chat list
            function formatTime(timestamp) {
                // Ensure timestamp is in milliseconds
                if (timestamp < 1000000000000) {
                    timestamp = timestamp * 1000;
                }

                const now = Date.now();
                const diff = now - timestamp;

                // Sanity check - if timestamp is in the future or too far in the past
                if (diff < 0 || diff > 315576000000) { // if more than 10 years
                    return 'Unknown time';
                }

                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 30) return `${days}d ago`;

                // Fall back to actual date for older messages
                return new Date(timestamp).toLocaleDateString();
            }

            // Update chat list in sidebar
            function updateChatList() {
                chatList.innerHTML = '';

                // Sort chats by last activity
                const sortedChats = Object.values(chatHistory).sort((a, b) => b.lastActivity - a.lastActivity);

                sortedChats.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;

                    const lastMessage = chat.messages.length > 0 ? chat.messages[chat.messages.length - 1].content : 'New chat';
                    const preview = lastMessage.length > 40 ? lastMessage.substring(0, 40) + '...' : lastMessage;

                    chatItem.innerHTML = `
                        <div class="chat-item-header">
                            <div class="chat-item-title">${chat.character}</div>
                            <button class="chat-item-delete" title="Delete chat">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <div class="chat-item-preview">${preview}</div>
                        <div class="chat-item-time">${formatTime(chat.lastActivity)}</div>
                    `;

                    // Add click handler for the chat item
                    chatItem.onclick = (e) => {
                        // Don't trigger if clicking the delete button
                        if (!e.target.closest('.chat-item-delete')) {
                            loadChat(chat.id);
                        }
                    };

                    // Add delete button handler
                    const deleteBtn = chatItem.querySelector('.chat-item-delete');
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`Are you sure you want to delete this chat with ${chat.character}?`)) {
                            delete chatHistory[chat.id];
                            if (currentChatId === chat.id) {
                                // If deleting current chat, create a new one
                                createNewChat();
                            } else {
                                updateChatList();
                            }
                        }
                    };

                    chatList.appendChild(chatItem);
                });
            }

            // Load a specific chat
            function loadChat(chatId) {
                console.log('Loading chat:', chatId);
                if (!chatHistory[chatId]) {
                    console.error('Chat not found:', chatId);
                    return;
                }

                const chat = chatHistory[chatId];
                console.log('Loading chat data:', chat);

                currentChatId = chatId;
                activeCharacter = chat.character;

                // Update character select
                if (characterSelect.value !== activeCharacter) {
                    console.log('Updating character select to:', activeCharacter);
                    characterSelect.value = activeCharacter;
                }

                // Update character info
                updateCharacterInfo();

                // Clear and load messages
                chatMessages.innerHTML = '';
                chat.messages.forEach(msg => {
                    addMessage(
                        msg.content,
                        msg.type || msg.role,
                        msg.character || activeCharacter,
                        msg.timestamp
                    );
                });

                // If no messages, show welcome message
                if (chatHistory[chatId].messages.length === 0) {
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'welcome-message';
                    welcomeDiv.innerHTML = `
                        <h2 class="welcome-title">Chat with ${activeCharacter}</h2>
                        <p class="welcome-subtitle">Start your conversation!</p>
                    `;
                    chatMessages.appendChild(welcomeDiv);
                }

                updateChatList();
                updateCharacterInfo();
            }

            // Clear all chat history
            clearHistoryBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all chat history? This action cannot be undone.')) {
                    chatHistory = {};
                    createNewChat();
                }
            });

            // Event listeners
            characterSelect.addEventListener('change', () => {
                createNewChat(characterSelect.value);
            });

            newChatBtn.addEventListener('click', () => {
                createNewChat();
            });

            // Initialize first chat
            if (Object.keys(chatHistory).length === 0) {
                createNewChat();
            } else {
                // Load the most recent chat
                const sortedChats = Object.values(chatHistory).sort((a, b) => b.lastActivity - a.lastActivity);
                if (sortedChats.length > 0) {
                    loadChat(sortedChats[0].id);
                } else {
                    createNewChat();
                }
            }

            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Send message on Enter (but not Shift+Enter)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendButton.addEventListener('click', sendMessage);

            async function sendMessage() {
                const message = messageInput.value.trim();
                const char = characterSelect.value;
                if (!message || isProcessing) return;

                isProcessing = true;
                sendButton.disabled = true;
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                // Remove welcome message if it exists
                const welcomeMessage = document.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }

                // Create message objects
                const userMsg = {
                    content: message,
                    type: 'user',
                    timestamp: Date.now(),
                    chatId: currentChatId
                };

                // Add user message
                addMessage(message, 'user');
                if (currentChatId && chatHistory[currentChatId]) {
                    chatHistory[currentChatId].messages.push(userMsg);
                    chatHistory[currentChatId].lastActivity = Date.now();
                }

                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';

                // Add loading message
                const loadingMessage = addLoadingMessage();

                try {
                    const res = await fetch('/chat', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            message: message,
                            character: char,
                            chatId: currentChatId
                        })
                    });
                    const data = await res.json();

                    // Remove loading message
                    if (loadingMessage) {
                        loadingMessage.remove();
                    }

                    // Create AI message object
                    const aiMsg = {
                        content: data.reply,
                        type: 'ai',
                        character: char,
                        timestamp: Date.now(),
                        chatId: currentChatId
                    };

                    addMessage(data.reply, 'ai', char);
                    if (currentChatId && chatHistory[currentChatId]) {
                        chatHistory[currentChatId].messages.push(aiMsg);
                        chatHistory[currentChatId].lastActivity = Date.now();
                    }

                    // Update chat list to show latest message
                    updateChatList();
                } catch (error) {
                    console.error('Error sending message:', error);

                    // Remove loading message
                    if (loadingMessage) {
                        loadingMessage.remove();
                    }

                    const errorMsg = 'Sorry, there was an error processing your message. Please try again.';
                    addMessage(errorMsg, 'ai', char);
                    if (currentChatId && chatHistory[currentChatId]) {
                        chatHistory[currentChatId].messages.push({
                            content: errorMsg,
                            type: 'ai',
                            character: char,
                            timestamp: Date.now(),
                            chatId: currentChatId
                        });
                        chatHistory[currentChatId].lastActivity = Date.now();
                    }
                }

                isProcessing = false;
                sendButton.disabled = false;
                sendButton.innerHTML = '<span>Send</span><i class="fas fa-paper-plane"></i>';
            }

            function addLoadingMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai loading';

                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';

                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-dots';
                loadingDiv.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';

                bubble.appendChild(loadingDiv);
                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);

                chatMessages.scrollTop = chatMessages.scrollHeight;
                return messageDiv;
            }

            function addMessage(content, type, character = '', timestamp = null) {
                console.log('Adding message:', { content, type, character, timestamp });

                const now = Date.now();
                timestamp = timestamp || now;

                // Ensure timestamp is in milliseconds
                if (timestamp < 1000000000000) {
                    timestamp = timestamp * 1000;
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.dataset.timestamp = timestamp;

                // Add timestamp display
                const timeDisplay = document.createElement('div');
                timeDisplay.className = 'message-time';
                timeDisplay.textContent = formatTime(timestamp);
                messageDiv.appendChild(timeDisplay);

                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';

                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';

                if (type === 'ai') {
                    messageContent.innerHTML = parseMarkdown(content);
                } else {
                    messageContent.innerHTML = escapeHtml(content).replace(/\n/g, '<br>');
                }

                bubble.appendChild(messageContent);
                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);

                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function parseMarkdown(text) {
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/^### (.*$)/gm, '<h3 style="margin: 0.5rem 0; color: var(--accent-sakura);">$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2 style="margin: 0.5rem 0; color: var(--accent-sakura);">$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1 style="margin: 0.5rem 0; color: var(--accent-sakura);">$1</h1>')
                    .replace(/^- (.*$)/gm, '<li style="margin-left: 1rem;">$1</li>')
                    .replace(/^\d+\. (.*$)/gm, '<li style="margin-left: 1rem; list-style-type: decimal;">$1</li>')
                    .replace(/(<li.*<\/li>)/s, '<ul style="margin: 0.5rem 0;">$1</ul>')
                    .replace(/^> (.*$)/gm, '<blockquote style="border-left: 3px solid var(--accent-lavender); padding-left: 1rem; margin: 0.5rem 0; font-style: italic;">$1</blockquote>')
                    .replace(/`(.*?)`/g, '<code style="background: var(--secondary-bg); padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace;">$1</code>')
                    .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" style="color: var(--accent-lavender); text-decoration: underline;">$1</a>')
                    .replace(/\n/g, '<br>');
            }
    </script>
  </body>
</html>
